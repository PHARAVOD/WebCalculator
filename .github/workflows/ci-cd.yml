name: Web Calculator CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    steps:
      - name: üí∑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: üí∑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: üí∑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          echo "=== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –í–°–ï–• –ü–†–û–ï–ö–¢–û–í ==="
          # –ù–∞—Ö–æ–¥–∏–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ .csproj —Ñ–∞–π–ª—ã
          find . -name "*.csproj" -type f | while read proj; do
            echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: $proj"
            dotnet restore "$proj"
          done

      - name: üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç
        run: |
          echo "=== –°–ë–û–†–ö–ê –û–°–ù–û–í–ù–û–ì–û –ü–†–û–ï–ö–¢–ê ==="
          dotnet build src/WebCalculator/WebCalculator.csproj --configuration Release
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

      - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        uses: actions/upload-artifact@v4
        with:
          name: web-calculator-app
          path: src/WebCalculator/bin/Release/net8.0/
          retention-days: 7

      - name: ‚úì –ó–∞–ø—É—Å–∫–∞–µ–º unit-—Ç–µ—Å—Ç—ã
        run: |
          echo "=== –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í ==="
          # –ò—â–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
          TEST_PROJ=$(find . -name "*Test*.csproj" -type f | head -1)
          if [ -n "$TEST_PROJ" ]; then
            echo "–ù–∞–π–¥–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç: $TEST_PROJ"
            dotnet test "$TEST_PROJ" --verbosity normal --logger "trx"
          else
            echo "‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi

      - name: üì¶ –ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        run: |
          echo "=== –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==="
          dotnet publish src/WebCalculator/WebCalculator.csproj -c Release -o ./publish --self-contained false
          echo "‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

      - name: üìé –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        run: |
          zip -r web-calculator-v1.0.0.zip ./publish/*
          echo "–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞:"
          ls -lh web-calculator-v1.0.0.zip

      - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: web-calculator-v1.0.0.zip
          retention-days: 30

      - name: üìÑ –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
        run: |
          echo "============================================================="
          echo "üìå CI/CD –ü–ê–ô–ü–õ–ê–ù –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù! ‚úÖ"
          echo "============================================================="
          echo ""
          echo "üìã –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –≠–¢–ê–ü–´:"
          echo "   ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞"
          echo "   ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
          echo "   ‚úÖ –°–±–æ—Ä–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
          echo "   ‚úÖ –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤"
          echo "   ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞"
          echo ""
          echo "üì¶ –°–û–ó–î–ê–ù–ù–´–ï –ê–†–¢–ï–§–ê–ö–¢–´:"
          echo "   ‚óè web-calculator-app - —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
          echo "   ‚óè release-package - —Ä–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç"
          echo ""
          echo "üïí –í—Ä–µ–º—è: $(date)"
          echo ""