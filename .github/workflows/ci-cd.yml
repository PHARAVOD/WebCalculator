name: Web Calculator CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  setup:
    name: üí∑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    runs-on: ubuntu-latest
    steps:
      - name: üí∑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
        run: |
          echo "=== –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ==="
          find . -name "*.csproj" -type f
          echo ""
          echo "=== –°–û–î–ï–†–ñ–ò–ú–û–ï tests/ ==="
          ls -R tests/ || echo "–ü–∞–ø–∫–∞ tests/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          echo ""
          echo "=== –¢–ï–ö–£–©–ê–Ø –î–ò–†–ï–ö–¢–û–†–ò–Ø ==="
          pwd

      - name: üí∑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üí∑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          # –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç
          dotnet restore src/WebCalculator/WebCalculator.csproj
          
          # –ò—â–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
          if [ -f "tests/WebCalculator.Tests.csproj" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç: tests/WebCalculator.Tests.csproj"
            dotnet restore tests/WebCalculator.Tests.csproj
          elif [ -f "tests/WebCalculator.Tests/WebCalculator.Tests.csproj" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç: tests/WebCalculator.Tests/WebCalculator.Tests.csproj"
            dotnet restore tests/WebCalculator.Tests/WebCalculator.Tests.csproj
          elif [ -f "tests/WebCalculator.Tests/WebCalculator.Tests.csproj" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç: tests/WebCalculator.Tests/WebCalculator.Tests.csproj"
            dotnet restore tests/WebCalculator.Tests/WebCalculator.Tests.csproj
          else
            echo "‚ùå –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            echo "–ò—â–µ–º –≤—Å–µ .csproj —Ñ–∞–π–ª—ã:"
            find . -name "*.csproj" -type f
            exit 1
          fi

  build:
    name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: üí∑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: üí∑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
        run: dotnet build src/WebCalculator/WebCalculator.csproj --configuration Release --no-restore

      - name: üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
          ls -la src/WebCalculator/bin/Release/net8.0/

      - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        uses: actions/upload-artifact@v4
        with:
          name: web-calculator-app
          path: src/WebCalculator/bin/Release/net8.0/
          retention-days: 7

  test:
    name: ‚úì –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: üí∑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: üí∑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ‚úì –ó–∞–ø—É—Å–∫–∞–µ–º unit-—Ç–µ—Å—Ç—ã
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
          cd tests
          dotnet test --verbosity normal --logger "trx"
          # –ò–õ–ò –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –≤ –ø–æ–¥–ø–∞–ø–∫–µ:
          # dotnet test WebCalculator.Tests.csproj --verbosity normal --logger "trx"

      - name: üìä –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/TestResults/  # –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –ø—É—Ç—å!
          retention-days: 30

  # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ job –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  package:
    name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: üí∑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: üí∑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üì¶ –ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        run: dotnet publish src/WebCalculator/WebCalculator.csproj -c Release -o ./publish --self-contained false

      - name: üìé –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        run: |
          zip -r web-calculator-v1.0.0.zip ./publish/*
          echo "–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞:"
          ls -lh web-calculator-v1.0.0.zip

      - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: web-calculator-v1.0.0.zip
          retention-days: 30

  report:
    name: üìÑ –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    needs: [setup, build, test, package]
    runs-on: ubuntu-latest
    steps:
      - name: üìÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        run: |
          echo "============================================================="
          echo "üìå CI/CD –ü–ê–ô–ü–õ–ê–ù –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù! ‚úÖ"
          echo "============================================================="
          echo ""
          echo "üìã –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –≠–¢–ê–ü–´:"
          echo "   ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
          echo "   ‚úÖ –°–±–æ—Ä–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
          echo "   ‚úÖ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"
          echo "   ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞"
          echo ""
          echo "üì¶ –°–û–ó–î–ê–ù–ù–´–ï –ê–†–¢–ï–§–ê–ö–¢–´:"
          echo "   ‚óè web-calculator-app - —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
          echo "   ‚óè test-results - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
          echo "   ‚óè release-package - —Ä–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç"
          echo ""
          echo "üïí –í—Ä–µ–º—è: $(date)"
          echo ""